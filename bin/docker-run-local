#!/bin/bash

set -e

get_repo_dir () {
  SOURCE="${BASH_SOURCE[0]}"
  # While $SOURCE is a symlink, resolve it
  while [ -h "$SOURCE" ]; do
       DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
       SOURCE="$( readlink "$SOURCE" )"
       # If $SOURCE was a relative symlink (so no "/" as prefix, need to resolve
       # it relative to the symlink base directory
       [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
  done
  DIR="$( cd -P "$( dirname "$SOURCE" )/.." && pwd )"
  echo "$DIR"
}

if [ -z "$TAG" ]; then
  TAG="latest"
fi

if [ -z "$APP_MODE" ]; then
  echo "WARNING: No APP_MODE specified. Assuming 'api'."
  export APP_MODE="api"
fi

if [ -z "$YAML_CONFIG_PATH" ]; then
  echo "WARNING: Using config/local.example.yaml config. This probably won't work."
  YAML_CONFIG_PATH="/app/config/local.example.yaml"
fi

docker run \
  --env "HELLO_FULL_STACK_APP_MODE=$APP_MODE" \
  --env "HELLO_FULL_STACK_YAML_CONFIG_PATH=$YAML_CONFIG_PATH" \
  --interactive \
  --publish 8000:8000 \
  --rm \
  --tty \
  --volume "$(get_repo_dir)/config:/app/config" \
  "hello-full-stack:$TAG"
